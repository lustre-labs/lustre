var wt=5,Z=Math.pow(2,wt),Pn=Z-1,Ln=Z/2,Rn=Z/4;var Ee=[" ","	",`
`,"\v","\f","\r","\x85","\u2028","\u2029"].join(""),Or=new RegExp(`^[${Ee}]*`),Ir=new RegExp(`[${Ee}]*$`);var Pe=0;var Le=1;var Re=2;var Fe=0;var se=2;var V=0;var G=1;var oe=2;var He=3;var W=4;var Ve=5;var Ge=0;var We=1;var Je=2;var Ye=3;var Qe=4;var Xe=5;var Ke=6;var et="	",tt="\r";var y=()=>globalThis?.document,le="http://www.w3.org/1999/xhtml";var rt=!!globalThis.HTMLElement?.prototype?.moveBefore;var cn=globalThis.setTimeout,ce=globalThis.clearTimeout,un=(l,e)=>y().createElementNS(l,e),an=l=>y().createTextNode(l),fn=()=>y().createDocumentFragment(),j=(l,e,t)=>l.insertBefore(e,t),it=rt?(l,e,t)=>l.moveBefore(e,t):j,pn=(l,e)=>l.removeChild(e),dn=(l,e)=>l.getAttribute(e),st=(l,e,t)=>l.setAttribute(e,t),hn=(l,e)=>l.removeAttribute(e),_n=(l,e,t,r)=>l.addEventListener(e,t,r),ot=(l,e,t)=>l.removeEventListener(e,t),mn=(l,e)=>l.innerHTML=e,xn=(l,e)=>l.data=e,g=Symbol("lustre"),ae=class{constructor(e,t,r,n){this.kind=e,this.key=n,this.parent=t,this.children=[],this.node=r,this.handlers=new Map,this.throttles=new Map,this.debouncers=new Map}get isVirtual(){return this.kind===V||this.kind===W}get parentNode(){return this.isVirtual?this.node.parentNode:this.node}};var Y=(l,e,t,r,n)=>{let s=new ae(l,e,t,n);return t[g]=s,e?.children.splice(r,0,s),s},$n=l=>{let e="";for(let t=l[g];t.parent;t=t.parent){let r=t.parent&&t.parent.kind===W?tt:et;if(t.key)e=`${r}${t.key}${e}`;else{let n=t.parent.children.indexOf(t);e=`${r}${n}${e}`}}return e.slice(1)},U=class{#r=null;#e;#t;#n=!1;constructor(e,t,r,{exposeKeys:n=!1}={}){this.#r=e,this.#e=t,this.#t=r,this.#n=n}mount(e){Y(G,null,this.#r,0,null),this.#p(this.#r,null,this.#r[g],0,e)}push(e,t=null){this.#i=t,this.#s.push({node:this.#r[g],patch:e}),this.#o()}#i;#s=[];#o(){let e=this.#s;for(;e.length;){let{node:t,patch:r}=e.pop(),{children:n}=t,{changes:s,removed:i,children:o}=r;E(s,c=>this.#d(t,c)),i&&this.#f(t,n.length-i,i),E(o,c=>{let p=n[c.index|0];this.#s.push({node:p,patch:c})})}}#d(e,t){switch(t.kind){case Ge:this.#v(e,t);break;case We:this.#g(e,t);break;case Je:this.#k(e,t);break;case Ye:this.#a(e,t);break;case Qe:this.#_(e,t);break;case Xe:this.#c(e,t);break;case Ke:this.#u(e,t);break}}#u(e,{children:t,before:r}){let n=fn(),s=this.#l(e,r);this.#$(n,null,e,r|0,t),j(e.parentNode,n,s)}#c(e,{index:t,with:r}){this.#f(e,t|0,1);let n=this.#l(e,t);this.#p(e.parentNode,n,e,t|0,r)}#l(e,t){t=t|0;let{children:r}=e,n=r.length;if(t<n)return r[t].node;let s=r[n-1];if(!s&&!e.isVirtual)return null;for(s||(s=e);s.isVirtual&&s.children.length;)s=s.children[s.children.length-1];return s.node.nextSibling}#a(e,{key:t,before:r}){r=r|0;let{children:n,parentNode:s}=e,i=n[r].node,o=n[r];for(let m=r+1;m<n.length;++m){let w=n[m];if(n[m]=o,o=w,w.key===t){n[r]=w;break}}let{node:c,children:p}=o;it(s,c,i),o.isVirtual&&this.#h(s,p,i)}#h(e,t,r){for(let n=0;n<t.length;++n){let s=t[n],{node:i,children:o}=s;it(e,i,r),s.isVirtual&&this.#h(e,o,r)}}#_(e,{index:t}){this.#f(e,t,1)}#f(e,t,r){let{children:n,parentNode:s}=e,i=n.splice(t,r);for(let o=0;o<i.length;++o){let c=i[o];pn(s,c.node),this.#m(c),c.isVirtual&&i.push(...c.children)}}#m(e){let{debouncers:t,children:r}=e;for(let{timeout:n}of t.values())n&&ce(n);t.clear(),E(r,n=>this.#m(n))}#k({node:e,handlers:t,throttles:r,debouncers:n},{added:s,removed:i}){E(i,({name:o})=>{t.delete(o)?(ot(e,o,ue),this.#x(r,o,0),this.#x(n,o,0)):(hn(e,o),ct[o]?.removed?.(e,o))}),E(s,o=>this.#y(e,o))}#v({node:e},{content:t}){xn(e,t??"")}#g({node:e},{inner_html:t}){mn(e,t??"")}#$(e,t,r,n,s){E(s,i=>this.#p(e,t,r,n++,i))}#p(e,t,r,n,s){switch(s.kind){case G:{let i=this.#w(r,n,s);this.#$(i,null,i[g],0,s.children),j(e,i,t);break}case oe:{let i=this.#b(r,n,s);j(e,i,t);break}case V:{let i=this.#b(r,n,s);j(e,i,t),this.#$(e,t,i[g],0,s.children);break}case He:{let i=this.#w(r,n,s);this.#g({node:i},s),j(e,i,t);break}case W:{let i=this.#b(r,n,s);j(e,i,t),this.#p(e,t,i[g],0,s.child);break}case Ve:{let i=this.#i?.get(s.view)??s.view();this.#p(e,t,r,n,i);break}}}#w(e,t,{kind:r,key:n,tag:s,namespace:i,attributes:o}){let c=un(i||le,s);return Y(r,e,c,t,n),this.#n&&n&&st(c,"data-lustre-key",n),E(o,p=>this.#y(c,p)),c}#b(e,t,{kind:r,key:n,content:s}){let i=an(s??"");return Y(r,e,i,t,n),i}#y(e,t){let{debouncers:r,handlers:n,throttles:s}=e[g],{kind:i,name:o,value:c,prevent_default:p,debounce:m,throttle:w}=t;switch(i){case Pe:{let _=c??"";if(o==="virtual:defaultValue"){e.defaultValue=_;return}else if(o==="virtual:defaultChecked"){e.defaultChecked=!0;return}else if(o==="virtual:defaultSelected"){e.defaultSelected=!0;return}_!==dn(e,o)&&st(e,o,_),ct[o]?.added?.(e,_);break}case Le:e[o]=c;break;case Re:{n.has(o)&&ot(e,o,ue);let _=p.kind===Fe;_n(e,o,ue,{passive:_}),this.#x(s,o,w),this.#x(r,o,m),n.set(o,k=>this.#E(t,k));break}}}#x(e,t,r){let n=e.get(t);if(r>0)n?n.delay=r:e.set(t,{delay:r});else if(n){let{timeout:s}=n;s&&ce(s),e.delete(t)}}#E(e,t){let{currentTarget:r,type:n}=t,{debouncers:s,throttles:i}=r[g],o=$n(r),{prevent_default:c,stop_propagation:p,include:m}=e;c.kind===se&&t.preventDefault(),p.kind===se&&t.stopPropagation(),n==="submit"&&(t.detail??={},t.detail.formData=[...new FormData(t.target,t.submitter).entries()]);let w=this.#e(t,o,n,m),_=i.get(n);if(_){let _e=Date.now(),gt=_.last||0;_e>gt+_.delay&&(_.last=_e,_.lastEvent=t,this.#t(t,w))}let k=s.get(n);k&&(ce(k.timeout),k.timeout=cn(()=>{t!==i.get(n)?.lastEvent&&this.#t(t,w)},k.delay)),!_&&!k&&this.#t(t,w)}},E=(l,e)=>{if(Array.isArray(l))for(let t=0;t<l.length;t++)e(l[t]);else if(l)for(l;l.head;l=l.tail)e(l.head)},ue=l=>{let{currentTarget:e,type:t}=l;e[g].handlers.get(t)(l)},lt=l=>({added(e){e[l]=!0},removed(e){e[l]=!1}}),bn=l=>({added(e,t){e[l]=t}}),ct={checked:lt("checked"),selected:lt("selected"),value:bn("value"),autofocus:{added(l){queueMicrotask(()=>{l.focus?.()})}},autoplay:{added(l){try{l.play?.()}catch(e){console.error(e)}}}};var ft=new WeakMap;async function pt(l){let e=[];for(let r of y().querySelectorAll("link[rel=stylesheet], style"))r.sheet||e.push(new Promise((n,s)=>{r.addEventListener("load",n),r.addEventListener("error",s)}));if(await Promise.allSettled(e),!l.host.isConnected)return[];l.adoptedStyleSheets=l.host.getRootNode().adoptedStyleSheets;let t=[];for(let r of y().styleSheets)try{l.adoptedStyleSheets.push(r)}catch{try{let n=ft.get(r);if(!n){n=new CSSStyleSheet;for(let s of r.cssRules)n.insertRule(s.cssText,n.cssRules.length);ft.set(r,n)}l.adoptedStyleSheets.push(n)}catch{let n=r.ownerNode.cloneNode();l.prepend(n),t.push(n)}}return t}var Q=class extends Event{constructor(e,t,r){super("context-request",{bubbles:!0,composed:!0}),this.context=e,this.callback=t,this.subscribe=r}};var dt=0;var ht=1;var _t=2;var mt=3;var X=0;var xt=1;var $t=2;var K=3;var bt=4;var fe=class extends HTMLElement{static get observedAttributes(){return["route","method"]}#r;#e="ws";#t=null;#n=null;#i=[];#s;#o=new Set;#d=new Set;#u=!1;#c=[];#l=new Map;#a=new Set;#h=new MutationObserver(e=>{let t=[];for(let r of e){if(r.type!=="attributes")continue;let n=r.attributeName;(!this.#u||this.#o.has(n))&&t.push([n,this.getAttribute(n)])}if(t.length===1){let[r,n]=t[0];this.#n?.send({kind:X,name:r,value:n})}else t.length?this.#n?.send({kind:K,messages:t.map(([r,n])=>({kind:X,name:r,value:n}))}):this.#c.push(...t)});constructor(){super(),this.internals=this.attachInternals(),this.#h.observe(this,{attributes:!0})}connectedCallback(){for(let e of this.attributes)this.#c.push([e.name,e.value])}attributeChangedCallback(e,t,r){switch(e){case(t!==r&&"route"):{this.#t=new URL(r,location.href),this.#_();return}case"method":{let n=r.toLowerCase();if(n==this.#e)return;["ws","sse","polling"].includes(n)&&(this.#e=n,this.#e=="ws"&&(this.#t.protocol=="https:"&&(this.#t.protocol="wss:"),this.#t.protocol=="http:"&&(this.#t.protocol="ws:")),this.#_());return}}}async messageReceivedCallback(e){switch(e.kind){case dt:{for(this.#r??=this.attachShadow({mode:e.open_shadow_root?"open":"closed"});this.#r.firstChild;)this.#r.firstChild.remove();let t=(i,o,c,p)=>{let m=this.#m(i,p??[]);return{kind:xt,path:o,name:c,event:m}},r=(i,o)=>{this.#n?.send(o)};this.#s=new U(this.#r,t,r),this.#o=new Set(e.observed_attributes);let s=this.#c.filter(([i])=>this.#o.has(i)).map(([i,o])=>({kind:X,name:i,value:o}));this.#c=[],this.#d=new Set(e.observed_properties);for(let i of this.#d)Object.defineProperty(this,i,{get(){return this[`_${i}`]},set(o){this[`_${i}`]=o,this.#n?.send({kind:$t,name:i,value:o})}});for(let[i,o]of Object.entries(e.provided_contexts))this.provide(i,o);for(let i of[...new Set(e.requested_contexts)])this.dispatchEvent(new Q(i,(o,c)=>{this.#n?.send({kind:bt,key:i,value:o}),this.#a.add(c)}));s.length&&this.#n.send({kind:K,messages:s}),e.will_adopt_styles&&await this.#f(),this.#r.addEventListener("context-request",i=>{if(!i.context||!i.callback||!this.#l.has(i.context))return;i.stopImmediatePropagation();let o=this.#l.get(i.context);if(i.subscribe){let c=new WeakRef(i.callback),p=()=>{o.subscribers=o.subscribers.filter(m=>m!==c)};o.subscribers.push([c,p]),i.callback(o.value,p)}else i.callback(o.value)}),this.#s.mount(e.vdom),this.dispatchEvent(new CustomEvent("lustre:mount"));break}case ht:{this.#s.push(e.patch);break}case _t:{this.dispatchEvent(new CustomEvent(e.name,{detail:e.data}));break}case mt:{this.provide(e.key,e.value);break}}}disconnectedCallback(){for(let e of this.#a)e();this.#a.clear()}provide(e,t){if(!this.#l.has(e))this.#l.set(e,{value:t,subscribers:[]});else{let r=this.#l.get(e);r.value=t;for(let n=r.subscribers.length-1;n>=0;n--){let[s,i]=r.subscribers[n],o=s.deref();if(!o){r.subscribers.splice(n,1);continue}o(t,i)}}}#_(){if(!this.#t||!this.#e)return;this.#n&&this.#n.close();let n={onConnect:()=>{this.#u=!0,this.dispatchEvent(new CustomEvent("lustre:connect"),{detail:{route:this.#t,method:this.#e}})},onMessage:s=>{this.messageReceivedCallback(s)},onClose:()=>{this.#u=!1,this.dispatchEvent(new CustomEvent("lustre:close",{detail:{route:this.#t,method:this.#e}}))}};switch(this.#e){case"ws":this.#n=new pe(this.#t,n);break;case"sse":this.#n=new de(this.#t,n);break;case"polling":this.#n=new he(this.#t,n);break}}async#f(){for(;this.#i.length;)this.#i.pop().remove(),this.#r.firstChild.remove();this.#i=await pt(this.#r)}#m(e,t=[]){let r={};(e.type==="input"||e.type==="change")&&t.push("target.value"),e.type==="submit"&&t.push("detail.formData");for(let n of t){let s=n.split(".");for(let i=0,o=e,c=r;i<s.length;i++){if(i===s.length-1){c[s[i]]=o[s[i]];break}c=c[s[i]]??={},o=o[s[i]]}}return r}},pe=class{#r;#e;#t=!1;#n=[];#i;#s;#o;constructor(e,{onConnect:t,onMessage:r,onClose:n}){this.#r=e,this.#e=new WebSocket(this.#r),this.#i=t,this.#s=r,this.#o=n,this.#e.onopen=()=>{this.#i()},this.#e.onmessage=({data:s})=>{try{this.#s(JSON.parse(s))}finally{this.#n.length?this.#e.send(JSON.stringify({kind:K,messages:this.#n})):this.#t=!1,this.#n=[]}},this.#e.onclose=()=>{this.#o()}}send(e){if(this.#t||this.#e.readyState!==WebSocket.OPEN){this.#n.push(e);return}else this.#e.send(JSON.stringify(e)),this.#t=!0}close(){this.#e.close()}},de=class{#r;#e;#t;#n;#i;constructor(e,{onConnect:t,onMessage:r,onClose:n}){this.#r=e,this.#e=new EventSource(this.#r),this.#t=t,this.#n=r,this.#i=n,this.#e.onopen=()=>{this.#t()},this.#e.onmessage=({data:s})=>{try{this.#n(JSON.parse(s))}catch{}}}send(e){}close(){this.#e.close(),this.#i()}},he=class{#r;#e;#t;#n;#i;#s;constructor(e,{onConnect:t,onMessage:r,onClose:n,...s}){this.#r=e,this.#n=t,this.#i=r,this.#s=n,this.#e=s.interval??5e3,this.#o().finally(()=>{this.#n(),this.#t=setInterval(()=>this.#o(),this.#e)})}async send(e){}close(){clearInterval(this.#t),this.#s()}#o(){return fetch(this.#r).then(e=>e.json()).then(this.#i).catch(console.error)}};customElements.define("lustre-server-component",fe);export{fe as ServerComponent};
