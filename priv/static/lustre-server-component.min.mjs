var k=class{withFields(t){let n=Object.keys(this).map(r=>r in t?t[r]:this[r]);return new this.constructor(...n)}};function m(e,t){let n=[e,t];for(;n.length;){let r=n.pop(),i=n.pop();if(r===i)continue;if(!$e(r)||!$e(i)||!Qe(r,i)||Ge(r,i)||Ve(r,i)||Ke(r,i)||Ye(r,i)||Xe(r,i)||Ze(r,i))return!1;let u=Object.getPrototypeOf(r);if(u!==null&&typeof u.equals=="function")try{if(r.equals(i))continue;return!1}catch{}let[l,o]=Je(r);for(let f of l(r))n.push(o(r,f),o(i,f))}return!0}function Je(e){if(e instanceof Map)return[t=>t.keys(),(t,n)=>t.get(n)];{let t=e instanceof globalThis.Error?["message"]:[];return[n=>[...t,...Object.keys(n)],(n,r)=>n[r]]}}function Ge(e,t){return e instanceof Date&&(e>t||e<t)}function Ve(e,t){return e.buffer instanceof ArrayBuffer&&e.BYTES_PER_ELEMENT&&!(e.byteLength===t.byteLength&&e.every((n,r)=>n===t[r]))}function Ke(e,t){return Array.isArray(e)&&e.length!==t.length}function Ye(e,t){return e instanceof Map&&e.size!==t.size}function Xe(e,t){return e instanceof Set&&(e.size!=t.size||[...e].some(n=>!t.has(n)))}function Ze(e,t){return e instanceof RegExp&&(e.source!==t.source||e.flags!==t.flags)}function $e(e){return typeof e=="object"&&e!==null}function Qe(e,t){return typeof e!="object"&&typeof t!="object"&&(!e||!t)||[Promise,WeakSet,WeakMap,Function].some(r=>e instanceof r)?!1:e.constructor===t.constructor}var Ce=new WeakMap,ie=new DataView(new ArrayBuffer(8)),se=0;function ue(e){let t=Ce.get(e);if(t!==void 0)return t;let n=se++;return se===2147483647&&(se=0),Ce.set(e,n),n}function le(e,t){return e^t+2654435769+(e<<6)+(e>>2)|0}function fe(e){let t=0,n=e.length;for(let r=0;r<n;r++)t=Math.imul(31,t)+e.charCodeAt(r)|0;return t}function Ie(e){ie.setFloat64(0,e);let t=ie.getInt32(0),n=ie.getInt32(4);return Math.imul(73244475,t>>16^t)^n}function wt(e){return fe(e.toString())}function xt(e){let t=Object.getPrototypeOf(e);if(t!==null&&typeof t.hashCode=="function")try{let r=e.hashCode(e);if(typeof r=="number")return r}catch{}if(e instanceof Promise||e instanceof WeakSet||e instanceof WeakMap)return ue(e);if(e instanceof Date)return Ie(e.getTime());let n=0;if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),Array.isArray(e)||e instanceof Uint8Array)for(let r=0;r<e.length;r++)n=Math.imul(31,n)+$(e[r])|0;else if(e instanceof Set)e.forEach(r=>{n=n+$(r)|0});else if(e instanceof Map)e.forEach((r,i)=>{n=n+le($(r),$(i))|0});else{let r=Object.keys(e);for(let i=0;i<r.length;i++){let s=r[i],u=e[s];n=n+le($(u),fe(s))|0}}return n}function $(e){if(e===null)return 1108378658;if(e===void 0)return 1108378659;if(e===!0)return 1108378657;if(e===!1)return 1108378656;switch(typeof e){case"number":return Ie(e);case"string":return fe(e);case"bigint":return wt(e);case"object":return xt(e);case"symbol":return ue(e);case"function":return ue(e);default:return 0}}var A=5,ae=Math.pow(2,A),gt=ae-1,$t=ae/2,yt=ae/4,x=0,L=1,g=2,C=3,ce={type:g,bitmap:0,array:[]};function D(e,t){return e>>>t&gt}function G(e,t){return 1<<D(e,t)}function bt(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function pe(e,t){return bt(e&t-1)}function y(e,t,n){let r=e.length,i=new Array(r);for(let s=0;s<r;++s)i[s]=e[s];return i[t]=n,i}function kt(e,t,n){let r=e.length,i=new Array(r+1),s=0,u=0;for(;s<t;)i[u++]=e[s++];for(i[u++]=n;s<r;)i[u++]=e[s++];return i}function oe(e,t){let n=e.length,r=new Array(n-1),i=0,s=0;for(;i<t;)r[s++]=e[i++];for(++i;i<n;)r[s++]=e[i++];return r}function ze(e,t,n,r,i,s){let u=$(t);if(u===r)return{type:C,hash:u,array:[{type:x,k:t,v:n},{type:x,k:i,v:s}]};let l={val:!1};return B(de(ce,e,u,t,n,l),e,r,i,s,l)}function B(e,t,n,r,i,s){switch(e.type){case L:return Ot(e,t,n,r,i,s);case g:return de(e,t,n,r,i,s);case C:return Lt(e,t,n,r,i,s)}}function Ot(e,t,n,r,i,s){let u=D(n,t),l=e.array[u];if(l===void 0)return s.val=!0,{type:L,size:e.size+1,array:y(e.array,u,{type:x,k:r,v:i})};if(l.type===x)return m(r,l.k)?i===l.v?e:{type:L,size:e.size,array:y(e.array,u,{type:x,k:r,v:i})}:(s.val=!0,{type:L,size:e.size,array:y(e.array,u,ze(t+A,l.k,l.v,n,r,i))});let o=B(l,t+A,n,r,i,s);return o===l?e:{type:L,size:e.size,array:y(e.array,u,o)}}function de(e,t,n,r,i,s){let u=G(n,t),l=pe(e.bitmap,u);if(e.bitmap&u){let o=e.array[l];if(o.type!==x){let c=B(o,t+A,n,r,i,s);return c===o?e:{type:g,bitmap:e.bitmap,array:y(e.array,l,c)}}let f=o.k;return m(r,f)?i===o.v?e:{type:g,bitmap:e.bitmap,array:y(e.array,l,{type:x,k:r,v:i})}:(s.val=!0,{type:g,bitmap:e.bitmap,array:y(e.array,l,ze(t+A,f,o.v,n,r,i))})}else{let o=e.array.length;if(o>=$t){let f=new Array(32),c=D(n,t);f[c]=de(ce,t+A,n,r,i,s);let h=0,a=e.bitmap;for(let b=0;b<32;b++){if(a&1){let _=e.array[h++];f[b]=_}a=a>>>1}return{type:L,size:o+1,array:f}}else{let f=kt(e.array,l,{type:x,k:r,v:i});return s.val=!0,{type:g,bitmap:e.bitmap|u,array:f}}}}function Lt(e,t,n,r,i,s){if(n===e.hash){let u=he(e,r);if(u!==-1)return e.array[u].v===i?e:{type:C,hash:n,array:y(e.array,u,{type:x,k:r,v:i})};let l=e.array.length;return s.val=!0,{type:C,hash:n,array:y(e.array,l,{type:x,k:r,v:i})}}return B({type:g,bitmap:G(e.hash,t),array:[e]},t,n,r,i,s)}function he(e,t){let n=e.array.length;for(let r=0;r<n;r++)if(m(t,e.array[r].k))return r;return-1}function J(e,t,n,r){switch(e.type){case L:return At(e,t,n,r);case g:return Et(e,t,n,r);case C:return St(e,r)}}function At(e,t,n,r){let i=D(n,t),s=e.array[i];if(s!==void 0){if(s.type!==x)return J(s,t+A,n,r);if(m(r,s.k))return s}}function Et(e,t,n,r){let i=G(n,t);if(!(e.bitmap&i))return;let s=pe(e.bitmap,i),u=e.array[s];if(u.type!==x)return J(u,t+A,n,r);if(m(r,u.k))return u}function St(e,t){let n=he(e,t);if(!(n<0))return e.array[n]}function _e(e,t,n,r){switch(e.type){case L:return Nt(e,t,n,r);case g:return Tt(e,t,n,r);case C:return Ct(e,r)}}function Nt(e,t,n,r){let i=D(n,t),s=e.array[i];if(s===void 0)return e;let u;if(s.type===x){if(!m(s.k,r))return e}else if(u=_e(s,t+A,n,r),u===s)return e;if(u===void 0){if(e.size<=yt){let l=e.array,o=new Array(e.size-1),f=0,c=0,h=0;for(;f<i;){let a=l[f];a!==void 0&&(o[c]=a,h|=1<<f,++c),++f}for(++f;f<l.length;){let a=l[f];a!==void 0&&(o[c]=a,h|=1<<f,++c),++f}return{type:g,bitmap:h,array:o}}return{type:L,size:e.size-1,array:y(e.array,i,u)}}return{type:L,size:e.size,array:y(e.array,i,u)}}function Tt(e,t,n,r){let i=G(n,t);if(!(e.bitmap&i))return e;let s=pe(e.bitmap,i),u=e.array[s];if(u.type!==x){let l=_e(u,t+A,n,r);return l===u?e:l!==void 0?{type:g,bitmap:e.bitmap,array:y(e.array,s,l)}:e.bitmap===i?void 0:{type:g,bitmap:e.bitmap^i,array:oe(e.array,s)}}return m(r,u.k)?e.bitmap===i?void 0:{type:g,bitmap:e.bitmap^i,array:oe(e.array,s)}:e}function Ct(e,t){let n=he(e,t);if(n<0)return e;if(e.array.length!==1)return{type:C,hash:e.hash,array:oe(e.array,n)}}function Me(e,t){if(e===void 0)return;let n=e.array,r=n.length;for(let i=0;i<r;i++){let s=n[i];if(s!==void 0){if(s.type===x){t(s.v,s.k);continue}Me(s,t)}}}var j=class e{static fromObject(t){let n=Object.keys(t),r=e.new();for(let i=0;i<n.length;i++){let s=n[i];r=r.set(s,t[s])}return r}static fromMap(t){let n=e.new();return t.forEach((r,i)=>{n=n.set(i,r)}),n}static new(){return new e(void 0,0)}constructor(t,n){this.root=t,this.size=n}get(t,n){if(this.root===void 0)return n;let r=J(this.root,0,$(t),t);return r===void 0?n:r.v}set(t,n){let r={val:!1},i=this.root===void 0?ce:this.root,s=B(i,0,$(t),t,n,r);return s===this.root?this:new e(s,r.val?this.size+1:this.size)}delete(t){if(this.root===void 0)return this;let n=_e(this.root,0,$(t),t);return n===this.root?this:n===void 0?e.new():new e(n,this.size-1)}has(t){return this.root===void 0?!1:J(this.root,0,$(t),t)!==void 0}entries(){if(this.root===void 0)return[];let t=[];return this.forEach((n,r)=>t.push([r,n])),t}forEach(t){Me(this.root,t)}hashCode(){let t=0;return this.forEach((n,r)=>{t=t+le($(n),$(r))|0}),t}equals(t){if(!(t instanceof e)||this.size!==t.size)return!1;try{return this.forEach((n,r)=>{if(!m(t.get(r,!n),n))throw je}),!0}catch(n){if(n===je)return!1;throw n}}},je=Symbol();var qe=[" ","	",`
`,"\v","\f","\r","\x85","\u2028","\u2029"].join(""),si=new RegExp(`^[${qe}]*`),ui=new RegExp(`[${qe}]*$`);function H(){return j.new()}var me=class extends k{constructor(t){super(),this.dict=t}};function ve(){return new me(H())}var Ai=j.new();var Ei=ve();var De=0,Be=1,Re=2,we=4,V=5;globalThis.customElements&&!globalThis.customElements.get("lustre-fragment")&&globalThis.customElements.define("lustre-fragment",class extends HTMLElement{constructor(){super()}});function X(e,t,n){let r,i=[{prev:e,next:t,parent:e.parentNode}];for(;i.length;){let{prev:s,next:u,parent:l}=i.pop();for(;u.subtree!==void 0;)u=u.subtree();if(u.content!==void 0)if(s)if(s.nodeType===Node.TEXT_NODE)s.textContent!==u.content&&(s.textContent=u.content),r??=s;else{let o=document.createTextNode(u.content);l.replaceChild(o,s),r??=o}else{let o=document.createTextNode(u.content);l.appendChild(o),r??=o}else if(u.tag!==void 0){let o=zt({prev:s,next:u,dispatch:n,stack:i});s?s!==o&&l.replaceChild(o,s):l.appendChild(o),r??=o}}return r}function Pe(e,t,n,r=0){let i=e.parentNode;for(let s of t[0]){let u=s[0].split("-"),l=s[1],o=K(i,u,r),f;if(o!==null&&o!==i)f=X(o,l,n);else{let c=K(i,u.slice(0,-1),r),h=document.createTextNode("");c.appendChild(h),f=X(h,l,n)}u==="0"&&(e=f)}for(let s of t[1]){let u=s[0].split("-");K(i,u,r).remove()}for(let s of t[2]){let u=s[0].split("-"),l=s[1],o=K(i,u,r),f=q.get(o),c=[];for(let h of l[0]){let a=h[0],b=h[1];if(a.startsWith("data-lustre-on-")){let _=a.slice(15),z=n(Fe);f.has(_)||o.addEventListener(_,I),f.set(_,z),o.setAttribute(a,b)}else(a.startsWith("delegate:data-")||a.startsWith("delegate:aria-"))&&o instanceof HTMLSlotElement?c.push([a.slice(10),b]):(o.setAttribute(a,b),(a==="value"||a==="selected")&&(o[a]=b));if(c.length>0)for(let _ of o.assignedElements())for(let[z,R]of c)_[z]=R}for(let h of l[1])if(h.startsWith("data-lustre-on-")){let a=h.slice(15);o.removeEventListener(a,I),f.delete(a)}else o.removeAttribute(h)}return e}function zt({prev:e,next:t,dispatch:n,stack:r}){let i=t.namespace||"http://www.w3.org/1999/xhtml",s=e&&e.nodeType===Node.ELEMENT_NODE&&e.localName===t.tag&&e.namespaceURI===(t.namespace||"http://www.w3.org/1999/xhtml"),u=s?e:i?document.createElementNS(i,t.tag):document.createElement(t.tag),l;if(q.has(u))l=q.get(u);else{let p=new Map;q.set(u,p),l=p}let o=s?new Set(l.keys()):null,f=s?new Set(Array.from(e.attributes,p=>p.name)):null,c=null,h=null,a=null;if(s&&t.tag==="textarea"){let p=t.children[Symbol.iterator]().next().value?.content;p!==void 0&&(u.value=p)}let b=[];for(let p of t.attrs){let d=p[0],w=p[1];if(p.as_property)u[d]!==w&&(u[d]=w),s&&f.delete(d);else if(d.startsWith("on")){let O=d.slice(2),Q=n(w,O==="input");l.has(O)||u.addEventListener(O,I),l.set(O,Q),s&&o.delete(O)}else if(d.startsWith("data-lustre-on-")){let O=d.slice(15),Q=n(Fe);l.has(O)||u.addEventListener(O,I),l.set(O,Q),u.setAttribute(d,w),s&&(o.delete(O),f.delete(d))}else d.startsWith("delegate:data-")||d.startsWith("delegate:aria-")?(u.setAttribute(d,w),b.push([d.slice(10),w])):d==="class"?c=c===null?w:c+" "+w:d==="style"?h=h===null?w:h+w:d==="dangerous-unescaped-html"?a=w:(u.getAttribute(d)!==w&&u.setAttribute(d,w),(d==="value"||d==="selected")&&(u[d]=w),s&&f.delete(d))}if(c!==null&&(u.setAttribute("class",c),s&&f.delete("class")),h!==null&&(u.setAttribute("style",h),s&&f.delete("style")),s){for(let p of f)u.removeAttribute(p);for(let p of o)l.delete(p),u.removeEventListener(p,I)}if(t.tag==="slot"&&window.queueMicrotask(()=>{for(let p of u.assignedElements())for(let[d,w]of b)p.hasAttribute(d)||p.setAttribute(d,w)}),t.key!==void 0&&t.key!=="")u.setAttribute("data-lustre-key",t.key);else if(a!==null)return u.innerHTML=a,u;let _=u.firstChild,z=null,R=null,ge=null,Z=Y(t).next().value;if(s&&Z!==void 0&&Z.key!==void 0&&Z.key!==""){z=new Set,R=Ue(e),ge=Ue(t);for(let p of Y(t))_=Mt(_,p,u,r,ge,R,z)}else for(let p of Y(t))r.unshift({prev:_,next:p,parent:u}),_=_?.nextSibling;for(;_;){let p=_.nextSibling;u.removeChild(_),_=p}return u}var q=new WeakMap;function I(e){let t=e.currentTarget;if(!q.has(t)){t.removeEventListener(e.type,I);return}let n=q.get(t);if(!n.has(e.type)){t.removeEventListener(e.type,I);return}n.get(e.type)(e)}function Fe(e){let t=e.currentTarget,n=t.getAttribute(`data-lustre-on-${e.type}`),r=JSON.parse(t.getAttribute("data-lustre-data")||"{}"),i=JSON.parse(t.getAttribute("data-lustre-include")||"[]");switch(e.type){case"input":case"change":i.push("target.value");break}return{tag:n,data:i.reduce((s,u)=>{let l=u.split(".");for(let o=0,f=s,c=e;o<l.length;o++)o===l.length-1?f[l[o]]=c[l[o]]:(f[l[o]]??={},c=c[l[o]],f=f[l[o]]);return s},{data:r})}}function Ue(e){let t=new Map;if(e)for(let n of Y(e)){let r=n?.key||n?.getAttribute?.("data-lustre-key");r&&t.set(r,n)}return t}function K(e,t,n){let r,i,s=e,u=!0;for(;[r,...i]=t,r!==void 0;)s=s.childNodes.item(u?r+n:r),u=!1,t=i;return s}function Mt(e,t,n,r,i,s,u){for(;e&&!i.has(e.getAttribute("data-lustre-key"));){let o=e.nextSibling;n.removeChild(e),e=o}if(s.size===0)return r.unshift({prev:e,next:t,parent:n}),e=e?.nextSibling,e;if(u.has(t.key))return console.warn(`Duplicate key found in Lustre vnode: ${t.key}`),r.unshift({prev:null,next:t,parent:n}),e;u.add(t.key);let l=s.get(t.key);if(!l&&!e)return r.unshift({prev:null,next:t,parent:n}),e;if(!l&&e!==null){let o=document.createTextNode("");return n.insertBefore(o,e),r.unshift({prev:o,next:t,parent:n}),e}return!l||l===e?(r.unshift({prev:e,next:t,parent:n}),e=e?.nextSibling,e):(n.insertBefore(l,e),r.unshift({prev:l,next:t,parent:n}),e)}function*Y(e){for(let t of e.children)yield*We(t)}function*We(e){e.subtree!==void 0?yield*We(e.subtree()):yield e}var xe=class extends HTMLElement{static get observedAttributes(){return["route"]}constructor(){super(),this.attachShadow({mode:"open"}),this.#r=new MutationObserver(t=>{let n=[];for(let r of t)if(r.type==="attributes"){let{attributeName:i}=r,s=this.getAttribute(i);this[i]=s}n.length&&this.#e?.send(JSON.stringify([V,n]))})}connectedCallback(){this.#r.observe(this,{attributes:!0,attributeOldValue:!0}),this.#o().finally(()=>this.#i=!0)}attributeChangedCallback(t,n,r){switch(t){case"route":if(!r)this.#e?.close(),this.#e=null;else if(n!==r){let i=this.getAttribute("id"),s=r+(i?`?id=${i}`:""),u=window.location.protocol==="https:"?"wss":"ws";this.#n(`${u}://${window.location.host}${s}`)}}}messageReceivedCallback({data:t}){let[n,...r]=JSON.parse(t);switch(n){case De:return this.#u(r);case Be:return this.#l(r);case Re:return this.#s(r)}}disconnectedCallback(){this.#e?.close()}#r;#e;#i=!1;#t=[];#s([t,n]){let r=[];for(let u of t)u in this?r.push([u,this[u]]):this.hasAttribute(u)&&r.push([u,this.getAttribute(u)]),Object.defineProperty(this,u,{get(){return this[`__mirrored__${u}`]},set(l){let o=this[`__mirrored__${u}`];m(o,l)||(this[`__mirrored__${u}`]=l,this.#e?.send(JSON.stringify([V,[[u,l]]])))}});this.#r.observe(this,{attributeFilter:t,attributeOldValue:!0,attributes:!0,characterData:!1,characterDataOldValue:!1,childList:!1,subtree:!1});let i=this.shadowRoot.childNodes[this.#t.length]??this.shadowRoot.appendChild(document.createTextNode(""));X(i,n,u=>l=>{let o=JSON.parse(this.getAttribute("data-lustre-data")||"{}"),f=u(l);f.data=He(o,f.data),this.#e?.send(JSON.stringify([we,f.tag,f.data]))}),r.length&&this.#e?.send(JSON.stringify([V,r]))}#n(t=this.#e.url){this.#e?.close(),this.#e=new WebSocket(t),this.#e.addEventListener("message",n=>this.messageReceivedCallback(n)),this.#e.addEventListener("close",()=>{setTimeout(()=>{this.#e.readyState===WebSocket.CLOSED&&this.#n()},1e3)})}#u([t]){let n=this.shadowRoot.childNodes[this.#t.length-1]??this.shadowRoot.appendChild(document.createTextNode(""));Pe(n,t,i=>s=>{let u=i(s);this.#e?.send(JSON.stringify([we,u.tag,u.data]))},this.#t.length)}#l([t,n]){this.dispatchEvent(new CustomEvent(t,{detail:n}))}async#o(){let t=[];for(let r of document.querySelectorAll("link[rel=stylesheet]"))r.sheet||t.push(new Promise((i,s)=>{r.addEventListener("load",i),r.addEventListener("error",s)}));for(await Promise.allSettled(t);this.#t.length;)this.#t.shift().remove(),this.shadowRoot.firstChild.remove();this.shadowRoot.adoptedStyleSheets=this.getRootNode().adoptedStyleSheets;let n=[];for(let r of document.styleSheets)try{this.shadowRoot.adoptedStyleSheets.push(r)}catch{try{let i=new CSSStyleSheet;for(let s of r.cssRules)i.insertRule(s.cssText,i.cssRules.length);this.shadowRoot.adoptedStyleSheets.push(i)}catch{let i=r.ownerNode.cloneNode();this.shadowRoot.prepend(i),this.#t.push(i),n.push(new Promise((s,u)=>{i.onload=s,i.onerror=u}))}}return Promise.allSettled(n)}};window.customElements.define("lustre-server-component",xe);var He=(e,t)=>{for(let n in t)t[n]instanceof Object&&Object.assign(t[n],He(e[n],t[n]));return Object.assign(e||{},t),e};export{xe as LustreServerComponent};
